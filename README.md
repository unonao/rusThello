# rusThello

## Todo
### α-β法, negamaxの実装
自分が最大利益となる手を打ち、相手がこちらの利益が最小となるような手を打つような、簡単なminimaxを実装した。
negascoutなどの実装が必要。

### SIMD命令を使う
(使えるコンピュータなら)
Linuxなら
```
cat /proc/cpuinfo
```
で確認
https://doc.rust-lang.org/1.27.2/std/arch/index.html
参考: https://qiita.com/termoshtt/items/a1d3af42bc01c88273c8






## install
Rustのインストールのために、Unix系なら以下のコマンドを入力する

```
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

## 使い方
(rusThelloディレクトリで以下のコマンドを使用する)
```
cargo run -h "127.0.0.1" -p 3000 -n rusThello
```

または

```
cargo run
```

verboseは --verbose, debugは --debug, infoはデフォルトで --info
solve_depth(default: 18) -s 23
think_depth(default: 4) -t 7


対戦モード
```
cargo run --release -- -h "127.0.0.1" -p 3000 -n rusThello -s 23 -t 7
```

## Crate
### nom
parserのために、nom(version 5.0.0)を使用した。
### rand
rand = "0.7.0"
### lazy_static
グローバル変数を使用するため。
lazy_static = "1.3.0"

### clap
コマンドライン引数の使用

## ディレクトリ構成
srcディレクトリにソースコード一式がある。
- color.rs: 黒や白などの、石の色に関するファイル
- command_parser.rs: プロトコルで定められたメッセージをパースする関数や、構造体・列挙型を定義するファイル
- main.rs
- play.rs: オセロ用の基本関数やBoard構造体についてのファイル
- print.rs : print系の出力用関数を集めたファイル
- solver.rs: 終盤ソルバー用のファイル
- think.rs: 思考ルーチン用ファイル

## Openning book
Logistelloの棋譜データをもとに、序盤に似たような手を見つけたら、最も評価値が高い手をうつ。
BTreeMapはStringにたいしてRangeメソッドを使用できなかったので、u128に収まるように、前半21手分のデータを保存した。
book.rs内でBTreeMapへのinsertや検索などの関数を定義した。
前半21手分は、同様の棋譜が現れた場合、有力な手をうつことができる。

## Board
ファイルはplay.rs
bit boardで実装。
`u64`型２つで定義されたBoard構造体に対して、メソッドを定義することで基本的な操作を行う。

### flip(ひっくり返る石の数)
着手位置から見たそれぞれの方向についてマスクをとり、自身の石が連続する相手の石の先にあるかを判定。
ある場合は、挟まれた部分をビット演算を活用して取得する。
8方向を確認する必要があり、上、左、左上、右上のコード内容はほぼ同じであり（マスクが違う）、
下、右、右下、左下のコード内容もほぼ同じである。
4つずつ並列計算ができるならば、少し変更すればさらに高速化できる。

はじめはmobilityの計算と同様に、ビットシフトを繰り返して相手の石の場所を伝播させていったが、
計算に時間がかかるので、高速化のために変更した。

### mobility(着手位置の判定)
8方向それぞれについて、ビットシフトを繰り返して相手の石が連続する部分を伝播させていき、blankとの論理積を取れば良い。
無駄な関数呼び出しをなくして高速化した。
石を置くと左に向かって相手の石をひっくり返せるような位置に関しては、
```
p1 = p << 1;
 ~(p1 | o) & (p1 + o);
```
とすると、一気に計算ができる。

ビットボードを回転させるなどして、同様の計算を8方向に関して行うこともできるが、
回転するのにも計算時間がかかる上に、実装が手間なので今回は見送った。


### 細かい高速化の工夫
Board構造体のメソッドに変更した関数のうちいくつかは、if文で何度も自身のboardがBLACKかWHITEか判定していたので、
一度判定してから、playerのboardとopponentのboardを引数にして関数を実行するように変更した。


## 中盤
### 評価関数の実装
角や辺は得点が高く、角の周囲はマイナスの得点になるような、簡単な評価関数を実装した。



## solver
ファイルはsolver.rs
終盤ソルバーを実装。



### 速さ優先探索
相手が打てる候補が少なくなるような手から探索する。
反転数を何度も計算するので、専用のメソッドflippable_countを用意した。
内容は、flippable_stonesとほぼ同じである。

`--release`オプションをつければ、高速に計算できる。
実際に使う場合は24手読み前後まで可能。
```
count:24  16.279秒経過しました。
count:24  0.761秒経過しました。
count:24  0.000秒経過しました。
count:24  0.000秒経過しました。
count:24  0.000秒経過しました。
count:24  0.006秒経過しました。
count:24  1.065秒経過しました。
count:24  2.159秒経過しました。
count:24  0.055秒経過しました。
count:24  0.698秒経過しました。
count:24  0.000秒経過しました。
```

### 最終1手最適化
参考: http://sealsoft.jp/thell/algorithm.html
によると、通常の着手の処理を行わず、返る石の数だけを数えて最終結果を求めるという最終1手最適化をしたほうが早くなる。
参考サイトとは違いbitboardでの実装をしているので、通常の着手の処理を行うことになるが、
余分な条件分岐を加えるだけで、通常どおりに関数を呼び出すよりも高速化ができる。

### 最終2手最適化
残り2手のときは、ベクトルを作ってイテレートさせるのはコストパフォーマンスが悪いので、
直接条件分岐と再帰関数呼び出しを行う。


### 置換表　ソルバーにハッシュの導入
https://doc.rust-jp.rs/book/second-edition/ch08-03-hash-maps.html
3次元配列hash_mask[2][8][256(8bit)]の作成
1つ目: 打ち手のボードが相手のボードか
2つ目: u64を8bitずつ区切って、何個目か
3つ目: 区切った8bitの値
それぞれに、乱数を格納しておく。(乱数はu64の範囲)

hasherにhash_maskの値をもとにxorしたものを入れて、hashmapに格納or checkする。
→あまり効果なし（ロックしているせいか？）
以下計測
ただし
    pub const SOLVE_COUNT: i32 = 18;
    pub const SOLVE_SORT: i32 = 5;
のとき

depth 0 まで
```
count:18  0.169秒経過しました。
count:18  0.946秒経過しました。
count:18  0.308秒経過しました。
count:18  0.000秒経過しました。
count:18  0.380秒経過しました。
count:18  0.921秒経過しました。
count:18  0.000秒経過しました。
count:18  0.804秒経過しました。
count:18  0.003秒経過しました。
count:18  0.509秒経過しました。
count:18  0.000秒経過しました。
count:18  3.322秒経過しました。
count:18  0.000秒経過しました。
count:18  0.034秒経過しました。
count:18  0.000秒経過しました。
count:18  0.001秒経過しました。
count:18  0.756秒経過しました。
count:18  0.516秒経過しました。
count:18  0.172秒経過しました。
count:18  0.028秒経過しました。
count:18  0.019秒経過しました。
count:18  2.411秒経過しました。
count:18  0.031秒経過しました。
count:18  0.000秒経過しました。
count:18  0.240秒経過しました。
count:18  0.089秒経過しました。
participant:Player2 score:-28, win:11, lose:39
participant:rusThello score:28, win:39, lose:11
```

depth4
```
count:18  0.033秒経過しました。
count:18  0.117秒経過しました。
count:18  0.548秒経過しました。
count:18  0.000秒経過しました。
count:18  0.022秒経過しました。
count:18  0.000秒経過しました。
count:18  0.000秒経過しました。
count:18  0.752秒経過しました。
count:18  0.000秒経過しました。
count:18  0.003秒経過しました。
count:18  0.002秒経過しました。
count:18  0.117秒経過しました。
count:18  0.532秒経過しました。
count:18  0.005秒経過しました。
count:18  0.000秒経過しました。
count:18  1.153秒経過しました。
count:18  0.032秒経過しました。
count:18  1.039秒経過しました。
count:18  0.192秒経過しました。
count:18  0.104秒経過しました。
count:18  0.000秒経過しました。
count:18  0.011秒経過しました。
count:18  0.002秒経過しました。
count:18  1.957秒経過しました。
count:18  0.000秒経過しました。
count:18  0.001秒経過しました。
count:18  0.109秒経過しました。
count:18  0.000秒経過しました。
count:18  0.030秒経過しました。
participant:Player2 score:-28, win:11, lose:39
participant:rusThello score:28, win:39, lose:11
```

depth8
```
count:18  0.016秒経過しました。
count:18  0.000秒経過しました。
count:18  0.190秒経過しました。
count:18  0.006秒経過しました。
count:18  0.071秒経過しました。
count:18  0.325秒経過しました。
count:18  0.040秒経過しました。
count:18  0.640秒経過しました。
count:18  0.003秒経過しました。
count:18  0.000秒経過しました。
count:18  0.000秒経過しました。
count:18  0.001秒経過しました。
count:18  0.098秒経過しました。
count:18  0.000秒経過しました。
count:18  0.002秒経過しました。
count:18  0.019秒経過しました。
count:18  0.614秒経過しました。
count:18  1.754秒経過しました。
count:18  0.000秒経過しました。
count:18  0.000秒経過しました。
count:18  0.147秒経過しました。
count:18  0.000秒経過しました。
count:18  0.390秒経過しました。
count:18  0.030秒経過しました。
count:18  2.362秒経過しました。
count:18  1.318秒経過しました。
count:18  0.601秒経過しました。
count:18  0.000秒経過しました。
count:18  0.000秒経過しました。
count:18  0.039秒経過しました。
count:18  0.000秒経過しました。
participant:Player2 score:-28, win:11, lose:39
participant:rusThello score:28, win:39, lose:11
```

depth12
```
count:18  0.178秒経過しました。
count:18  0.000秒経過しました。
count:18  0.012秒経過しました。
count:18  1.620秒経過しました。
count:18  0.049秒経過しました。
count:18  0.387秒経過しました。
count:18  0.000秒経過しました。
count:18  0.061秒経過しました。
count:18  0.362秒経過しました。
count:18  0.174秒経過しました。
count:18  0.295秒経過しました。
count:18  0.001秒経過しました。
count:18  0.020秒経過しました。
count:18  1.667秒経過しました。
count:18  0.052秒経過しました。
count:18  0.282秒経過しました。
count:18  3.703秒経過しました。
count:18  0.001秒経過しました。
count:18  0.000秒経過しました。
count:18  0.110秒経過しました。
count:18  0.000秒経過しました。
count:18  0.140秒経過しました。
count:18  0.152秒経過しました。
count:18  0.009秒経過しました。
count:18  0.981秒経過しました。
count:18  0.132秒経過しました。
participant:Player2 score:-21, win:14, lose:35
participant:rusThello score:21, win:35, lose:14
```

depth16
```
count:18  0.000秒経過しました。
count:18  0.088秒経過しました。
count:18  0.004秒経過しました。
count:18  0.008秒経過しました。
count:18  0.006秒経過しました。
count:18  0.430秒経過しました。
count:18  0.347秒経過しました。
count:18  0.162秒経過しました。
count:18  0.354秒経過しました。
count:18  0.015秒経過しました。
count:18  0.192秒経過しました。
count:18  10.446秒経過しました。
count:18  0.680秒経過しました。
count:18  0.083秒経過しました。
count:18  0.020秒経過しました。
count:18  0.048秒経過しました。
count:18  0.000秒経過しました。
count:18  0.003秒経過しました。
count:18  0.429秒経過しました。
count:18  0.007秒経過しました。
count:18  0.025秒経過しました。
count:18  0.000秒経過しました。
count:18  1.632秒経過しました。
count:18  1.231秒経過しました。
count:18  0.621秒経過しました。
participant:Player2 score:-28, win:11, lose:39
participant:rusThello score:28, win:39, lose:11
```
